<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV予約解析</title>
</head>
<body>

  <h1>CSVファイルをアップロード</h1>
  <!-- multiple 属性を追加して複数ファイル選択を有効に -->
  <input type="file" id="csvFileInput" accept=".csv" multiple />
  <button onclick="processCSV()">CSV解析</button>

  <h2>結果</h2>
  <p id="result"></p>

  <script>
    function processCSV() {
      const input = document.getElementById('csvFileInput');
      const files = input.files;

      if (files.length === 0) {
        alert("CSVファイルを選択してください！");
        return;
      }

      let allCsvData = '';
      let processedFiles = 0;

      // 各ファイルを読み込む
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();

        reader.onload = function(e) {
          allCsvData += e.target.result + '\n'; // 複数ファイルのデータを結合
          processedFiles++;

          // 全てのファイルを読み込み終わったら解析を行う
          if (processedFiles === files.length) {
            const result = parseCSVAndFindMaxMin(allCsvData);
            displayResult(result);
          }
        };

        reader.readAsText(file);
      }
    }

    // CSVをパースして日付ごとの予約数を集計し、月の平均予約者数も計算
    function parseCSVAndFindMaxMin(csv) {
      const rows = csv.trim().split('\n');
      const reservationsByDate = {};
      const reservationsByMonth = {};

      rows.forEach(row => {
        const [count, dateTime] = row.split(',');
        const date = dateTime.replace(/"/g, '').split(' ')[0];
        const month = date.slice(0, 7); // 年-月（例："2024/07"）

        // 日付ごとの予約数を集計
        reservationsByDate[date] = (reservationsByDate[date] || 0) + parseInt(count, 10);

        // 月ごとの予約数を集計
        reservationsByMonth[month] = reservationsByMonth[month] || { total: 0, days: new Set() };
        reservationsByMonth[month].total += parseInt(count, 10);
        reservationsByMonth[month].days.add(date); // 月内の異なる日付を追跡
      });

      let maxReservations = -Infinity, minReservations = Infinity;
      const maxDates = [], minDates = [];

      // 予約数を見て、最大と最小の予約日をリストにする
      for (const [date, count] of Object.entries(reservationsByDate)) {
        if (count > maxReservations) {
          maxReservations = count;
          maxDates.length = 0; // 最大予約数が更新されたら、配列をリセット
          maxDates.push(date);
        } else if (count === maxReservations) {
          maxDates.push(date); // 同率の最大予約日があれば追加
        }

        if (count < minReservations) {
          minReservations = count;
          minDates.length = 0; // 最小予約数が更新されたら、配列をリセット
          minDates.push(date);
        } else if (count === minReservations) {
          minDates.push(date); // 同率の最小予約日があれば追加
        }
      }

      // 各月の平均予約者数を計算
      const averageReservationsByMonth = {};
      for (const [month, data] of Object.entries(reservationsByMonth)) {
        const numberOfDays = data.days.size;
        averageReservationsByMonth[month] = (data.total / numberOfDays).toFixed(2); // 小数点以下2桁で平均を表示
      }

      return {
        maxDates,
        minDates,
        maxReservations,
        minReservations,
        averageReservationsByMonth
      };
    }

    // 結果を画面に表示する関数
    function displayResult(result) {
      const resultElement = document.getElementById('result');
      const maxDatesStr = result.maxDates.join(', ');
      const minDatesStr = result.minDates.join(', ');
      let avgReservationsStr = '';

      for (const [month, avg] of Object.entries(result.averageReservationsByMonth)) {
        avgReservationsStr += `<strong>${month}</strong>: ${avg} 予約/日<br>`;
      }

      resultElement.innerHTML = `
        <strong>最高予約日:</strong> ${maxDatesStr} (${result.maxReservations} 予約)<br>
        <strong>最低予約日:</strong> ${minDatesStr} (${result.minReservations} 予約)<br>
        <h3>月ごとの平均予約者数</h3>
        ${avgReservationsStr}
      `;
    }
  </script>

</body>
</html>
